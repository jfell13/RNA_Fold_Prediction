import os
import sys
import functools
from typing import Final, List, Mapping, Tuple
import numpy as np
import collections
from collections import namedtuple
from collections.abc import Mapping, Sequence
import itertools
import dataclasses

"""List of atom types with reverse look-up."""

@dataclasses.dataclass(frozen=True, kw_only=True)
class Element:
    name: str
    number: int
    symbol: str
    weight: float
    vdw_rad: float
    e_neg: float

X: Final[Element] = Element(
    name='Unknown', number=0, symbol='X', weight=0.0, vdw_rad=0.0, e_neg=0.0)
H: Final[Element] = Element(
    name='Hydrogen', number=1, symbol='H', weight=1.008, vdw_rad=1.20, e_neg=2.20)
Li: Final[Element] = Element(
    name='Lithium', number=3, symbol='Li', weight=6.941, vdw_rad=1.82, e_neg=0.98)
Be: Final[Element] = Element(
    name='Beryllium', number=4, symbol='Be', weight=9.012, vdw_rad=1.53, e_neg=1.57)
C: Final[Element] = Element(
    name='Carbon', number=6, symbol='C', weight=12.011, vdw_rad=1.70, e_neg=2.55)
N: Final[Element] = Element(
    name='Nitrogen', number=7, symbol='N', weight=14.007, vdw_rad=1.55, e_neg=3.04)
O: Final[Element] = Element(
    name='Oxygen', number=8, symbol='O', weight=15.999, vdw_rad=1.52, e_neg=3.44)
F: Final[Element] = Element(
    name='Fluorine', number=9, symbol='F', weight=18.998, vdw_rad=1.47, e_neg=3.98)
Na: Final[Element] = Element(
    name='Sodium', number=11, symbol='Na', weight=22.99, vdw_rad=2.27, e_neg=0.93)
Mg: Final[Element] = Element(
    name='Magnesium', number=12, symbol='Mg', weight=24.305, vdw_rad=1.73, e_neg=1.31)
P: Final[Element] = Element(
    name='Phosphorus', number=15, symbol='P', weight=30.974, vdw_rad=1.80, e_neg=2.19)
S: Final[Element] = Element(
    name='Sulfur', number=16, symbol='S', weight=32.067, vdw_rad=1.80, e_neg=2.58)
Cl: Final[Element] = Element(
    name='Chlorine', number=17, symbol='Cl', weight=35.453, vdw_rad=1.75, e_neg=3.16)
K: Final[Element] = Element(
    name='Potassium', number=19, symbol='K', weight=39.098, vdw_rad=2.75, e_neg=0.82)
Ca: Final[Element] = Element(
    name='Calcium', number=20, symbol='Ca', weight=40.078, vdw_rad=2.31, e_neg=1.00)

PERIODIC_TABLE: Final[Sequence[Element]] = (X, H, Li, Be, C, N, O, F, Na, Mg, P, S, Cl, K, Ca)
ATOMIC_SYMBOL: Mapping[int, str] = {e.number: e.symbol for e in PERIODIC_TABLE}
ATOMIC_NUMBER: Mapping[str, int] = {e.symbol: e.number for e in PERIODIC_TABLE}
ATOMIC_WEIGHT: Mapping[str, float] = {e.symbol: e.weight for e in PERIODIC_TABLE}
VdW_RADIUS: Mapping[str, float] = {e.symbol: e.vdw_rad for e in PERIODIC_TABLE}
ELECTRONEGATIVITIES: Mapping[str, float] = {e.symbol: e.e_neg for e in PERIODIC_TABLE}

""" RNA structural definitions (angles, torsions, bonds, etc.) and information."""
A = sys.intern('A')
G = sys.intern('G')
C = sys.intern('C')
U = sys.intern('U')

UNK_RNA = sys.intern('X')  # Unknown RNA.

RNA_SMILES: Mapping[str, str] = {
    A:"O=P([O-])([O-])OC[C@H]3O[C@@H](n2cnc1c(ncnc12)N)[C@H](O)[C@@H]3O",
    C:"c1cn(c(=O)nc1N)[C@H]2[C@@H]([C@@H]([C@H](O2)COP(=O)(O)O)O)O",
    G:"C1=NC2=C(N1[C@H]3[C@@H]([C@@H]([C@H](O3)COP(=O)(O)O)O)O)NC(=NC2=O)N",
    U:"c1cn(c(=O)[nH]c1=O)[C@H]2[C@@H]([C@@H]([C@H](O2)COP(=O)(O)O)O)O"
}

# RNA atoms mapped to element

ATOM_ELEMENTS: Mapping[str, [str, ...]] = {
    "C":["C1'","C2'","C3'","C4'","C5'",'C2','C4','C5','C6','C7','C8'],
    "N":['N1','N2','N3','N4','N6','N7','N9'],
    "O":["O2'","O3'","O4'","O5'",'O2','O4','O6','OP1','OP2','OP3'],
    "P":['P']
}

# There are named torsional angles: 
# alpha, beta, gamma, delta, epsilon, zeta and chi

RNA_TYPES = {'pyrimidines' :[C, U],
            'purines' : [A, G]}

NAMED_ANGLES: Mapping[str, Sequence[tuple[str, ...]]] = { # was chi_angles_atoms
    'alpha': [("O3'", 'P', "O5'", "C5'")],
    'beta': [('P', "O5'", "C5'", "C4'")],
    'gamma': [("O5'", "C5'", "C4'", "C3'")],
    'delta': [("C5'", "C4'", "C3'", "O3'")],
    'epsilon': [("C4'", "C3'", "O3'", 'P')],
    'zeta': [("C3'", "O3'", 'P', "O5'")],
    'chi': [
        ("O4'", "C1'", 'N1', 'C2'),   # C & U
        ("O4'", "C1'", 'N9', 'C4'),   # A & G
    ]
}

# Torsional angles in order of alpha, beta, gamma, delta,
# epsilon, zeta, and chi based on RNA type.

RNA_TYPE_ANGLES = {
    'pyrimidines': [
        ("O3'", 'P', "O5'", "C5'"),
        ('P', "O5'", "C5'", "C4'"),
        ("O5'", "C5'", "C4'", "C3'"),
        ("C5'", "C4'", "C3'", "O3'"),
        ("C4'", "C3'", "O3'", 'P'),
        ("C3'", "O3'", 'P', "O5'"),
        ("O4'", "C1'", 'N1', 'C2')],
    'purines': [
        ("O3'", 'P', "O5'", "C5'"),
        ('P', "O5'", "C5'", "C4'"),
        ("O5'", "C5'", "C4'", "C3'"),
        ("C5'", "C4'", "C3'", "O3'"),
        ("C4'", "C3'", "O3'", 'P'),
        ("C3'", "O3'", 'P', "O5'"),
        ("O4'", "C1'", 'N9', 'C4')]
}

max_num_tors_angles: int = 7
atoms_per_tors_angle: int = 4

RNA_BACKBONE_ATOMS: tuple[str, ...] = ('OP3', 'P', "O5'", "C5'", "C4'", "C3'")

RN_ATOMS = {
    A: ['P','O1P','O2P','O3P',"C5'","O5'","C4'","O4'","C3'","O3'","C2'","O2'","C1'",'C1','N1','C2','N3','C4','C5','C6','N7','C8','N9'],
    C: ['P','O1P','O2P','O3P',"C5'","O5'","C4'","O4'","C3'","O3'","C2'","O2'","C1'",'N1','C2','O2','N3','C4','N4','C5','C6'],
    G: ['P','O1P','O2P','O3P',"C5'","O5'","C4'","O4'","C3'","O3'","C2'","O2'","C1'",'N1','C2','O2','N3','C4','N4','C5','C6'],
    U: ['P',"C5'","O5'","C4'","O4'","C3'","O3'","C2'","O2'","C1'",'N1','C2','O2','N3','C4','O4','C5','C6','OP1','OP2','OP3' ]
           }

RIGID_RN_ATOM_POS = {
    A: [
        ["P", (8.027, -6.507, 33.266)],
        ["O1P", (9.207, -5.675, 33.757)],
        ["O2P", (8.154, -6.900, 31.800)],
        ["O3P", (6.654, -5.950, 33.633)],
        ["C5'", (9.371, -8.566, 34.324)],
        ["O5'", (8.122, -7.879, 34.131)],
        ["C4'", (9.209, -9.832, 35.175)],
        ["O4'", (9.544, -9.623, 36.562)],
        ["C3'", (7.785, -10.384, 35.134)],
        ["O3'", (7.741, -11.544, 34.289)],
        ["C2'", (7.419, -10.699, 36.581)],
        ["O2'", (6.996, -12.057, 36.758)],
        ["C1'", (8.680, -10.424, 37.400)],
        ["N1", (10.507, -8.952, 42.125)],
        ["C2", (11.165, -9.494, 41.078)],
        ["N3", (10.553, -9.817, 39.914)],
        ["C4", (9.214, -9.616, 39.738)],
        ["C5", (8.432, -9.023, 40.837)],
        ["C6", (9.169, -8.694, 42.077)],
        ["N6", (8.510, -8.154, 43.128)],
        ["N7", (7.157, -8.928, 40.419)],
        ["C8", (7.127, -9.420, 39.155)],
        ["N9", (8.347, -9.826, 38.734)]
    ],
    C: [
        ["P", (-3.330, -4.760, 2.740)],
        ["O1P", (-4.083, -3.643, 3.364)],
        ["O2P", (-3.995, -5.603, 1.714)],
        ["O3P", (-2.767, -5.700, 3.895)],
        ["C5'", (-0.927, -4.919, 1.657)],
        ["O5'", (-2.018, -4.115, 2.105)],
        ["C4'", (0.310, -4.067, 1.496)],
        ["O4'", (0.071, -3.057, 0.478)],
        ["C3'", (0.697, -3.276, 2.738)],
        ["O3'", (1.533, -4.062, 3.578)],
        ["C2'", (1.452, -2.081, 2.166)],
        ["O2'", (2.821, -2.344, 1.941)],
        ["C1'", (0.729, -1.854, 0.834)],
        ["N1", (-0.244, -0.738, 0.825)],
        ["C2", (0.239, 0.576, 0.722)],
        ["O2", (1.466, 0.769, 0.718)],
        ["N3", (-0.641, 1.602, 0.643)],
        ["C4", (-1.951, 1.361, 0.666)],
        ["N4", (-2.780, 2.403, 0.539)],
        ["C5", (-2.472, 0.041, 0.811)],
        ["C6", (-1.592, -0.968, 0.887)]
    ],
    G: [
        ["P", (-3.330, -4.760, 2.740)],
        ["O1P", (-4.083, -3.643, 3.364)],
        ["O2P", (-3.995, -5.603, 1.714)],
        ["O3P", (-2.767, -5.700, 3.895)],
        ["C5'", (-0.927, -4.919, 1.657)],
        ["O5'", (-2.018, -4.115, 2.105)],
        ["C4'", (0.310, -4.067, 1.496)],
        ["O4'", (0.071, -3.057, 0.478)],
        ["C3'", (0.697, -3.276, 2.738)],
        ["O3'", (1.533, -4.062, 3.578)],
        ["C2'", (1.452, -2.081, 2.166)],
        ["O2'", (2.821, -2.344, 1.941)],
        ["C1'", (0.729, -1.854, 0.834)],
        ["N1", (-0.244, -0.738, 0.825)],
        ["C2", (0.239, 0.576, 0.722)],
        ["O2", (1.466, 0.769, 0.718)],
        ["N3", (-0.641, 1.602, 0.643)],
        ["C4", (-1.951, 1.361, 0.666)],
        ["N4", (-2.780, 2.403, 0.539)],
        ["C5", (-2.472, 0.041, 0.811)],
        ["C6", (-1.592, -0.968, 0.887)]
    ],
    U: [
        ["P", (37.875, 1.106, 65.721)],
        ["C5'", (40.541, 1.431, 65.746)],
        ["O5'", (39.226, 1.947, 66.083)],
        ["C4'", (41.435, 0.871, 66.869)],
        ["O4'", (40.718, -0.313, 67.351)],
        ["C3'", (42.843, 0.433, 66.445)],
        ["O3'", (43.958, 0.947, 67.261)],
        ["C2'", (42.751, -1.129, 66.411)],
        ["O2'", (43.918, -1.803, 66.958)],
        ["C1'", (41.423, -1.511, 67.096)],
        ["N1", (40.585, -2.452, 66.250)],
        ["C2", (40.726, -3.847, 66.405)],
        ["O2", (41.516, -4.301, 67.218)],
        ["N3", (39.911, -4.623, 65.574)],
        ["C4", (38.975, -4.148, 64.613)],
        ["O4", (38.329, -4.946, 63.957)],
        ["C5", (38.904, -2.730, 64.530)],
        ["C6", (39.664, -1.968, 65.301)],
        ["OP1", (37.600, 0.733, 64.279)],
        ["OP2", (36.668, 1.864, 66.134)],
        ["OP3", (37.957, -0.151, 66.797)]
    ]
}

RNA_ZMAT = {
    A: [
        ['P', 1],
        ['O1P', 1, 1.525],
        ['O2P', 1, 1.523, 2, 112.715],
        ['O3P', 1, 1.526, 2, 114.802, 3, 227.8],
        ["C5'", 1, 2.677, 2, 84.485, 3, 96.4],
        ["O5'", 5, 1.438, 1, 31.091, 2, 136.4],
        ["C4'", 5, 1.534, 1, 143.231, 2, 136.2],
        ["O4'", 7, 1.442, 5, 112.918, 1, 262.4],
        ["C3'", 7, 1.528, 5, 112.44, 1, 23.7],
        ["O3'", 9, 1.436, 7, 109.649, 5, 104.3],
        ["C2'", 9, 1.525, 7, 105.83, 5, 226.0],
        ["O2'", 11, 1.433, 9, 112.556, 7, 235.0],
        ["C1'", 8, 1.446, 7, 109.776, 5, 145.0],
        ['N1', 13, 5.275, 8, 99.067, 7, 181.4],
        ['C2', 14, 1.35, 13, 50.373, 8, 303.3],
        ['N3', 15, 1.354, 14, 122.824, 13, 0.3],
        ['C4', 16, 1.365, 15, 121.258, 14, 359.6],
        ['C5', 17, 1.473, 16, 118.919, 15, 0.6],
        ['C6', 14, 1.363, 13, 71.423, 8, 123.1],
        ['N6', 19, 1.353, 14, 121.746, 13, 179.6],
        ['N7', 18, 1.345, 17, 107.44, 16, 179.9],
        ['C8', 21, 1.357, 18, 106.551, 17, 360.0],
        ['N9', 17, 1.343, 16, 134.943, 15, 180.0]
    ],
    C: [
        ['P', 1],
        ['O1P', 1, 1.485],
        ['O2P', 1, 1.485, 2, 119.363],
        ['O3P', 1, 1.592, 2, 108.583, 3, 234.4],
        ["C5'", 1, 2.641, 2, 132.786, 3, 131.4],
        ["O5'", 5, 1.427, 1, 30.883, 2, 343.1],
        ["C4'", 5, 1.511, 1, 139.021, 2, 7.6],
        ["O4'", 7, 1.454, 5, 109.381, 1, 284.5],
        ["C3'", 7, 1.523, 5, 114.47, 1, 41.5],
        ["O3'", 9, 1.422, 7, 110.129, 5, 87.6],
        ["C2'", 9, 1.525, 7, 103.12, 5, 206.5],
        ["O2'", 11, 1.412, 9, 113.193, 7, 274.5],
        ["C1'", 8, 1.417, 7, 109.733, 5, 144.2],
        ['N1', 13, 1.481, 8, 109.469, 7, 233.9],
        ['C2', 14, 1.404, 13, 118.677, 8, 200.2],
        ['O2', 15, 1.242, 14, 119.051, 13, 356.0],
        ['N3', 15, 1.354, 14, 119.338, 13, 176.6],
        ['C4', 17, 1.332, 15, 120.067, 14, 0.1],
        ['N4', 18, 1.338, 17, 117.832, 15, 182.2],
        ['C5', 18, 1.426, 17, 121.891, 15, 1.8],
        ['C6', 20, 1.341, 18, 117.538, 17, 358.2]
    ],
    G: [
        ['P', 1],
        ['O1P', 1, 1.483],
        ['O2P', 1, 1.459, 2, 112.541],
        ['O3P', 1, 1.472, 2, 111.168, 3, 131.5],
        ["C5'", 1, 2.6, 2, 81.617, 3, 254.3],
        ["O5'", 5, 1.414, 1, 30.374, 2, 211.1],
        ["C4'", 5, 1.473, 1, 134.185, 2, 162.5],
        ["O4'", 7, 1.457, 5, 113.582, 1, 88.5],
        ["C3'", 7, 1.491, 5, 107.159, 1, 204.9],
        ["O3'", 9, 1.434, 7, 109.902, 5, 97.1],
        ["C2'", 9, 1.474, 7, 104.062, 5, 217.0],
        ["O2'", 11, 1.419, 9, 111.436, 7, 269.8],
        ["C1'", 8, 1.439, 7, 111.996, 5, 119.9],
        ['N1', 13, 5.265, 8, 140.959, 7, 263.1],
        ['C2', 14, 1.399, 13, 52.128, 8, 175.5],
        ['N2', 15, 1.333, 14, 117.198, 13, 180.1],
        ['N3', 15, 1.361, 14, 122.953, 13, 0.1],
        ['C4', 17, 1.386, 15, 113.3, 14, 359.9],
        ['C5', 18, 1.388, 17, 126.236, 15, 0.2],
        ['C6', 14, 1.396, 13, 72.34, 8, 355.4],
        ['O6', 20, 1.228, 14, 120.017, 13, 179.8],
        ['N7', 19, 1.393, 18, 110.424, 17, 179.9],
        ['C8', 22, 1.305, 19, 104.766, 18, 360.0],
        ['N9', 23, 1.388, 22, 114.344, 19, 360.0]
    ],
    U: [
        ['P', 1],
        ["C5'", 1, 2.686],
        ["O5'", 2, 1.452, 1, 31.39],
        ["C4'", 2, 1.541, 1, 122.598, 3, 93.3],
        ["O4'", 4, 1.466, 2, 104.445, 1, 28.8],
        ["C3'", 4, 1.534, 2, 115.773, 1, 147.5],
        ["O3'", 6, 1.474, 4, 116.205, 2, 130.4],
        ["C2'", 6, 1.565, 4, 103.708, 2, 256.1],
        ["O2'", 8, 1.454, 6, 114.027, 4, 221.1],
        ["C1'", 5, 1.413, 4, 112.421, 2, 114.5],
        ['N1', 10, 1.518, 5, 110.531, 4, 238.4],
        ['C2', 11, 1.411, 10, 119.782, 5, 211.4],
        ['O2', 12, 1.221, 11, 120.363, 10, 0.2],
        ['N3', 12, 1.399, 11, 115.154, 10, 180.2],
        ['C4', 14, 1.423, 12, 126.81, 11, 359.9],
        ['O4', 15, 1.218, 14, 119.584, 12, 180.1],
        ['C5', 15, 1.422, 14, 113.893, 12, 0.1],
        ['C6', 17, 1.324, 15, 120.746, 14, 0.0],
        ['OP1', 1, 1.515, 2, 102.643, 3, 130.6],
        ['OP2', 1, 1.484, 2, 137.986, 3, 2.2],
        ['OP3', 1, 1.657, 2, 92.1, 3, 248.0]
    ]
}
Bond = namedtuple('Bond', ['atom1_name', 'atom2_name', 'length', 'stddev'])
BondAngle = namedtuple('BondAngle', ['atom1_name', 'atom2_name', 'atom3name', 'angle_rad', 'stddev'])

